<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Izin Cuti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        input, textarea, select {
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ====================================================================
        // KONFIGURASI - GANTI DENGAN URL GOOGLE APPS SCRIPT ANDA
        // ====================================================================
        const CONFIG = {
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyUzK2L35jz-6qVdY_YM6TiEsSCXb4VahhlQnYAb8StBEXf9c1y4RudIM1dpsqWMFrE/exec',
            ADMIN_EMAIL: 'mitrakpubctanjungpriok@gmail.com' // Email untuk notifikasi
        };

        // ====================================================================
        // API Functions
        // ====================================================================
        const API = {
            verifyAdmin: async (username, password) => {
                try {
                    const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=verifyAdmin&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            },

            changeAdminPassword: async (username, oldPassword, newPassword) => {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'changeAdminPassword',
                            username,
                            oldPassword,
                            newPassword
                        })
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            },

            getEmployees: async () => {
                try {
                    const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=getEmployees`);
                    const data = await response.json();
                    return data.employees || [];
                } catch (error) {
                    console.error('Error:', error);
                    return [];
                }
            },

            getLeaveRequests: async () => {
                try {
                    const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=getLeaveRequests`);
                    const data = await response.json();
                    return data.requests || [];
                } catch (error) {
                    console.error('Error:', error);
                    return [];
                }
            },

            submitLeaveRequest: async (requestData) => {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'submitLeaveRequest',
                            data: requestData
                        })
                    });
                    return { success: true, request: requestData };
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            },

            updateLeaveStatus: async (requestId, status, adminName) => {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateLeaveStatus',
                            requestId,
                            status,
                            adminName
                        })
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            },

            addEmployee: async (employeeData) => {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'addEmployee',
                            data: employeeData
                        })
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            },

            updateEmployee: async (employeeId, employeeData) => {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updateEmployee',
                            employeeId,
                            data: employeeData
                        })
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            },

            deleteEmployee: async (employeeId) => {
                try {
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'deleteEmployee',
                            employeeId
                        })
                    });
                    return { success: true };
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            }
        };

        // ====================================================================
        // State Management
        // ====================================================================
        const state = {
            isAdminLoggedIn: false,
            adminUsername: 'admin',
            adminPassword: '',
            showAdminLogin: false,
            showChangePassword: false,
            employees: [],
            selectedEmployee: null,
            page: 'select',
            leaveRequests: [],
            photoPreview: null,
            searchTerm: '',
            loading: false,
            error: null,
            formData: {
                jabatan: '',
                unitKerja: '',
                cutiType: '',
                alasanCuti: '',
                lamaPengambilan: '',
                startDate: '',
                endDate: '',
                alamatCuti: '',
                nomorTelepon: '',
                petugasPengganti: '',
                persetujuanPengawas: '',
                photo: null
            },
            submittedData: null,
            currentTime: new Date(),
            adminFilterDate: '',
            showEmployeeForm: false,
            showImportModal: false,
            employeeFormData: {
                id: '',
                name: '',
                totalLeave: 12,
                supervisorName: '',
                supervisorPhone: ''
            },
            editingEmployee: null,
            oldPassword: '',
            newPassword: '',
            confirmPassword: '',
            employeeSearchTerm: ''
        };

        // ====================================================================
        // Utility Functions
        // ====================================================================
        function calculateDays(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (startDate > endDate) return 0;
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Disetujui': return 'bg-green-100 text-green-800 border-green-200';
                case 'Ditolak': return 'bg-red-100 text-red-800 border-red-200';
                default: return 'bg-yellow-100 text-yellow-800 border-yellow-200';
            }
        }

        function formatTime(date) {
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatDate(date) {
            return date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function openWhatsApp(phone, message) {
            const cleanPhone = phone.replace(/\D/g, '');
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${cleanPhone}?text=${encodedMessage}`, '_blank');
        }

        // Update state tanpa re-render penuh
        function updateSearchTerm(value) {
            state.searchTerm = value;
            // Hanya update daftar karyawan tanpa re-render seluruh page
            updateEmployeeList();
        }

        function updateEmployeeList() {
            const container = document.getElementById('employeeListContainer');
            if (!container) return;

            const filteredEmployees = state.employees.filter(emp => 
                emp.name.toLowerCase().includes(state.searchTerm.toLowerCase())
            );

            container.innerHTML = filteredEmployees.map(emp => `
                <button onclick='handleSelectEmployee("${emp.id}")'
                    class="bg-white hover:bg-indigo-50 border-2 border-gray-200 hover:border-indigo-400 p-4 rounded-xl transition-all text-left shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-100 p-3 rounded-full flex-shrink-0">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="font-semibold text-gray-800 block truncate">${emp.name}</span>
                            <span class="text-xs text-gray-500">Sisa Cuti: ${emp.totalLeave - emp.usedLeave} hari</span>
                        </div>
                    </div>
                </button>
            `).join('');

            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8 col-span-full">Tidak ada karyawan ditemukan</p>';
            }
        }

        // Update employee search di modal
        function updateEmployeeSearchTerm(value) {
            state.employeeSearchTerm = value;
            updateModalEmployeeList();
        }

        function updateModalEmployeeList() {
            const container = document.getElementById('modalEmployeeListContainer');
            if (!container) return;

            const filteredEmployees = state.employees.filter(emp => 
                emp.name.toLowerCase().includes(state.employeeSearchTerm.toLowerCase()) ||
                emp.id.toLowerCase().includes(state.employeeSearchTerm.toLowerCase())
            );

            container.innerHTML = filteredEmployees.map(emp => `
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 gap-3">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${emp.name}</p>
                        <p class="text-xs text-gray-500">ID: ${emp.id}</p>
                        <p class="text-sm text-gray-600">
                            Total: ${emp.totalLeave} hari | Terpakai: ${emp.usedLeave} hari | Sisa: ${emp.totalLeave - emp.usedLeave} hari
                        </p>
                        ${emp.supervisorPhone ? `<p class="text-xs text-blue-600">ðŸ“± WA Pengawas: ${emp.supervisorPhone}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick='handleEditEmployee(${JSON.stringify(emp)})'
                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                            Edit
                        </button>
                        <button onclick="handleDeleteEmployee('${emp.id}')"
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            Hapus
                        </button>
                    </div>
                </div>
            `).join('');

            if (filteredEmployees.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Tidak ada karyawan ditemukan</p>';
            }
        }

        // ====================================================================
        // Event Handlers
        // ====================================================================
        async function loadData() {
            state.loading = true;
            state.error = null;
            render();
            
            try {
                const [employeesData, requestsData] = await Promise.all([
                    API.getEmployees(),
                    API.getLeaveRequests()
                ]);
                state.employees = employeesData;
                state.leaveRequests = requestsData;
                
                // Jika tidak ada data dari backend, gunakan data contoh
                if (state.employees.length === 0) {
                    state.employees = [
                        { id: '192', name: 'SANDI ALJABAR', totalLeave: 12, usedLeave: 0, supervisorPhone: '6281234567890' },
                        { id: '2', name: 'AHMAD SYAIFUL', totalLeave: 12, usedLeave: 2, supervisorPhone: '6281234567891' },
                        { id: '89', name: 'AJI KURNIA RAMADHAN', totalLeave: 12, usedLeave: 0, supervisorPhone: '6281234567892' },
                        { id: '101', name: 'BUDI SANTOSO', totalLeave: 12, usedLeave: 3, supervisorPhone: '6281234567893' },
                        { id: '202', name: 'DEWI LESTARI', totalLeave: 12, usedLeave: 1, supervisorPhone: '6281234567894' }
                    ];
                }
            } catch (err) {
                // Jika error, tetap gunakan data contoh
                state.employees = [
                    { id: '192', name: 'SANDI ALJABAR', totalLeave: 12, usedLeave: 0, supervisorPhone: '6281234567890' },
                    { id: '2', name: 'AHMAD SYAIFUL', totalLeave: 12, usedLeave: 2, supervisorPhone: '6281234567891' },
                    { id: '89', name: 'AJI KURNIA RAMADHAN', totalLeave: 12, usedLeave: 0, supervisorPhone: '6281234567892' },
                    { id: '101', name: 'BUDI SANTOSO', totalLeave: 12, usedLeave: 3, supervisorPhone: '6281234567893' },
                    { id: '202', name: 'DEWI LESTARI', totalLeave: 12, usedLeave: 1, supervisorPhone: '6281234567894' }
                ];
                state.error = 'Menggunakan data contoh. Hubungkan dengan Google Sheets untuk data sebenarnya.';
                console.error(err);
            } finally {
                state.loading = false;
                render();
            }
        }

        function handlePhotoCapture(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    state.photoPreview = reader.result;
                    state.formData.photo = reader.result;
                    render();
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleSubmitLeave() {
            const { formData, selectedEmployee, employees } = state;
            
            // Validasi
            if (!formData.jabatan) {
                alert('Mohon isi Jabatan!');
                return;
            }
            if (!formData.unitKerja) {
                alert('Mohon isi Unit Kerja!');
                return;
            }
            if (!formData.cutiType) {
                alert('Mohon pilih Jenis Cuti!');
                return;
            }
            if (!formData.alasanCuti) {
                alert('Mohon isi Alasan Cuti!');
                return;
            }
            if (!formData.lamaPengambilan) {
                alert('Mohon pilih Lama Pengambilan Cuti!');
                return;
            }
            if (!formData.startDate || !formData.endDate) {
                alert('Mohon isi Tanggal Mulai dan Selesai!');
                return;
            }
            if (!formData.alamatCuti) {
                alert('Mohon isi Alamat Selama Menjalani Cuti!');
                return;
            }
            if (!formData.nomorTelepon) {
                alert('Mohon isi Nomor Telepon!');
                return;
            }
            if (!formData.petugasPengganti) {
                alert('Mohon isi Petugas Pengganti!');
                return;
            }
            if (formData.jabatan === 'Anggota' && !formData.persetujuanPengawas) {
                alert('Mohon pilih status persetujuan pengawas!');
                return;
            }
            if (formData.cutiType === 'Cuti Sakit' && !formData.photo) {
                alert('Wajib lampirkan foto/surat dokter untuk Cuti Sakit!');
                return;
            }

            const days = calculateDays(formData.startDate, formData.endDate);
            if (days <= 0) {
                alert('Tanggal mulai harus sebelum atau sama dengan tanggal selesai!');
                return;
            }

            const employee = employees.find(e => e.id === selectedEmployee);
            const remainingLeave = employee.totalLeave - employee.usedLeave;

            if (formData.cutiType === 'Cuti Tahunan' && days > remainingLeave) {
                alert(`Sisa cuti tahunan tidak mencukupi! Sisa: ${remainingLeave} hari.`);
                return;
            }

            state.loading = true;
            render();

            const requestData = {
                id: Date.now().toString(),
                employeeId: selectedEmployee,
                employeeName: employee.name,
                jabatan: formData.jabatan,
                unitKerja: formData.unitKerja,
                cutiType: formData.cutiType,
                alasanCuti: formData.alasanCuti,
                lamaPengambilan: formData.lamaPengambilan,
                startDate: formData.startDate,
                endDate: formData.endDate,
                alamatCuti: formData.alamatCuti,
                nomorTelepon: formData.nomorTelepon,
                petugasPengganti: formData.petugasPengganti,
                persetujuanPengawas: formData.persetujuanPengawas || 'N/A',
                supervisorPhone: employee.supervisorPhone || '',
                days: days,
                photo: formData.photo,
                status: 'Menunggu',
                submittedAt: new Date().toISOString()
            };

            const result = await API.submitLeaveRequest(requestData);

            if (result.success) {
                await loadData();
                state.submittedData = {
                    employee: employee,
                    request: requestData,
                    remainingLeave: formData.cutiType === 'Cuti Tahunan' 
                        ? employee.totalLeave - (employee.usedLeave + days)
                        : employee.totalLeave - employee.usedLeave
                };
                state.page = 'result';
            } else {
                alert('Gagal mengajukan cuti: ' + (result.error || 'Unknown error'));
            }

            state.loading = false;
            render();
        }

        function handleSelectEmployee(empId) {
            console.log('Selected Employee ID:', empId, 'Type:', typeof empId);
            console.log('Current Employees:', state.employees);
            
            // Flexible matching - convert both to string for comparison
            const employee = state.employees.find(e => String(e.id) === String(empId));
            
            if (!employee) {
                console.error('Employee not found! ID:', empId);
                console.log('Available IDs:', state.employees.map(e => ({id: e.id, type: typeof e.id})));
                alert('Karyawan tidak ditemukan! Silakan coba lagi.');
                return;
            }
            
            console.log('Employee found:', employee);
            
            // Store as string for consistency
            state.selectedEmployee = String(empId);
            state.page = 'form';
            state.formData = {
                jabatan: '',
                unitKerja: '',
                cutiType: '',
                alasanCuti: '',
                lamaPengambilan: '',
                startDate: '',
                endDate: '',
                alamatCuti: '',
                nomorTelepon: '',
                petugasPengganti: '',
                persetujuanPengawas: '',
                photo: null
            };
            state.photoPreview = null;
            render();
        }

        function handleBackToSelect() {
            state.page = 'select';
            state.selectedEmployee = null;
            state.submittedData = null;
            state.searchTerm = '';
            render();
        }

        async function handleApproveReject(requestId, action) {
            const request = state.leaveRequests.find(r => r.id === requestId);

            if (action === 'approve' && request.cutiType === 'Cuti Tahunan') {
                const employee = state.employees.find(e => e.id === request.employeeId);
                const remainingLeave = employee.totalLeave - employee.usedLeave;
                if (request.days > remainingLeave) {
                    alert(`Gagal menyetujui: Sisa cuti tahunan ${employee.name} tidak mencukupi (${remainingLeave} hari)!`);
                    return;
                }
            }

            state.loading = true;
            render();

            const status = action === 'approve' ? 'Disetujui' : 'Ditolak';
            const result = await API.updateLeaveStatus(requestId, status, 'Admin');

            if (result.success) {
                await loadData();
                alert(`Pengajuan cuti ${status.toLowerCase()}!`);
            } else {
                alert('Gagal memperbarui status: ' + (result.error || 'Unknown error'));
            }

            state.loading = false;
            render();
        }

        async function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                alert('Mohon isi username dan password!');
                return;
            }

            state.loading = true;
            render();

            const result = await API.verifyAdmin(username, password);

            if (result.success) {
                state.isAdminLoggedIn = true;
                state.adminUsername = username;
                state.showAdminLogin = false;
                state.page = 'admin';
            } else {
                alert(result.error || 'Username atau password salah!');
            }

            state.loading = false;
            render();
        }

        function handleAdminLogout() {
            state.isAdminLoggedIn = false;
            state.page = 'select';
            state.adminUsername = 'admin';
            state.adminPassword = '';
            state.showChangePassword = false;
            state.oldPassword = '';
            state.newPassword = '';
            state.confirmPassword = '';
            render();
        }

        async function handleChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                alert('Mohon isi semua field!');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password baru harus minimal 6 karakter!');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Password baru dan konfirmasi tidak cocok!');
                return;
            }

            state.loading = true;
            render();

            const result = await API.changeAdminPassword(state.adminUsername, oldPassword, newPassword);

            if (result.success) {
                alert('Password berhasil diubah!');
                state.showChangePassword = false;
                state.oldPassword = '';
                state.newPassword = '';
                state.confirmPassword = '';
            } else {
                alert(result.error || 'Gagal mengubah password!');
            }

            state.loading = false;
            render();
        }

        async function handleSaveEmployee() {
            const empId = document.getElementById('empId')?.value;
            const empName = document.getElementById('empName')?.value;
            const empTotalLeave = parseInt(document.getElementById('empLeave')?.value);
            const empSupervisor = document.getElementById('empSupervisor')?.value;

            console.log('=== SAVE EMPLOYEE DEBUG ===');
            console.log('empId:', empId);
            console.log('empName:', empName);
            console.log('empTotalLeave (dari input):', empTotalLeave);
            console.log('empSupervisor:', empSupervisor);
            console.log('state.editingEmployee:', state.editingEmployee);

            if (!empName) {
                alert('MOHON ISI NAMA KARYAWAN!');
                return;
            }

            if (isNaN(empTotalLeave) || empTotalLeave < 0 || empTotalLeave > 12) {
                alert('TOTAL CUTI HARUS ANTARA 0-12 HARI!');
                return;
            }

            if (!state.editingEmployee && !empId) {
                alert('MOHON ISI ID KARYAWAN (NIP/NIK)!');
                return;
            }

            if (!state.editingEmployee) {
                const isDuplicate = state.employees.some(emp => emp.id === empId);
                if (isDuplicate) {
                    alert(`ID "${empId}" SUDAH DIGUNAKAN! GUNAKAN ID YANG BERBEDA.`);
                    return;
                }
            }

            // Hitung cuti terpakai: jika admin input 5 (sisa), maka terpakai = 12 - 5 = 7
            const usedLeave = 12 - empTotalLeave;

            console.log('Calculated usedLeave:', usedLeave);

            const employeeData = {
                id: state.editingEmployee ? state.editingEmployee.id : empId,
                name: empName,
                totalLeave: 12, // Total cuti selalu 12 hari
                usedLeave: usedLeave, // Dihitung dari pengurangan (12 - input)
                supervisorPhone: empSupervisor
            };

            console.log('Employee Data to save:', employeeData);

            // UPDATE STATE LOKAL LANGSUNG (karena no-cors mode)
            if (state.editingEmployee) {
                // Update existing employee
                const index = state.employees.findIndex(e => e.id === state.editingEmployee.id);
                if (index !== -1) {
                    state.employees[index] = employeeData;
                }
            } else {
                // Add new employee
                state.employees.push(employeeData);
            }

            // Kirim ke backend (meskipun no-cors tidak bisa verify response)
            state.loading = true;
            render();

            let result;
            if (state.editingEmployee) {
                result = await API.updateEmployee(state.editingEmployee.id, employeeData);
            } else {
                result = await API.addEmployee(employeeData);
            }

            // Close form dan reset
            state.showEmployeeForm = false;
            state.editingEmployee = null;
            state.employeeFormData = { id: '', name: '', totalLeave: 12, supervisorPhone: '' };
            state.employeeSearchTerm = '';
            state.loading = false;
            
            alert(state.editingEmployee ? 'KARYAWAN BERHASIL DIUPDATE!' : 'KARYAWAN BERHASIL DITAMBAHKAN!');
            
            render();
        }

        async function handleDeleteEmployee(empId) {
            if (!confirm('Yakin ingin menghapus karyawan ini?')) return;

            state.loading = true;
            render();

            const result = await API.deleteEmployee(empId);

            if (result.success) {
                await loadData();
                alert('Karyawan berhasil dihapus!');
            } else {
                alert('Gagal menghapus karyawan: ' + (result.error || 'Unknown error'));
            }

            state.loading = false;
            render();
        }

        function handleEditEmployee(emp) {
            state.editingEmployee = emp;
            // Hitung sisa cuti untuk ditampilkan di form
            const sisaCuti = (emp.totalLeave || 12) - (emp.usedLeave || 0);
            state.employeeFormData = {
                id: emp.id,
                name: emp.name,
                totalLeave: sisaCuti, // Tampilkan sisa cuti, bukan total
                supervisorPhone: emp.supervisorPhone || ''
            };
            state.showEmployeeForm = true;
            state.employeeSearchTerm = '';
            render();
        }

        function handleContactSupervisor(request) {
            if (!request.supervisorPhone) {
                alert('Nomor WhatsApp pengawas belum tersedia!');
                return;
            }

            const message = `Halo, saya ingin konfirmasi pengajuan cuti:\n\nNama: ${request.employeeName}\nJabatan: ${request.jabatan}\nUnit: ${request.unitKerja}\nJenis Cuti: ${request.cutiType}\nTanggal: ${request.startDate} s/d ${request.endDate}\nDurasi: ${request.days} hari\nAlasan: ${request.alasanCuti}\n\nApakah ${request.employeeName} sudah izin untuk mengajukan cuti ini?`;
            
            openWhatsApp(request.supervisorPhone, message);
        }

        // ====================================================================
        // Render Functions
        // ====================================================================
        function renderAdminLogin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 flex items-center justify-center p-8">
                    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Login Admin</h2>
                            <button onclick="state.showAdminLogin = false; render();" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="adminUsername" value="${state.adminUsername}" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="Masukkan username">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="adminPassword" 
                                    onkeypress="if(event.key === 'Enter') handleAdminLogin()"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="Masukkan password">
                            </div>
                            
                            <button onclick="handleAdminLogin()" ${state.loading ? 'disabled' : ''}
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:opacity-50">
                                ${state.loading ? 'Memverifikasi...' : 'Login'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminPanel() {
            const pendingRequests = state.leaveRequests.filter(r => r.status === 'Menunggu');
            const approvedCount = state.leaveRequests.filter(r => r.status === 'Disetujui').length;
            const rejectedCount = state.leaveRequests.filter(r => r.status === 'Ditolak').length;
            
            const filteredProcessedRequests = state.leaveRequests
                .filter(r => r.status !== 'Menunggu')
                .filter(r => {
                    if (!state.adminFilterDate) return true;
                    const requestDate = new Date(r.submittedAt).toISOString().split('T')[0];
                    return requestDate === state.adminFilterDate;
                })
                .sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 p-4 md:p-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8">
                            <!-- Header -->
                            <div class="flex flex-col md:flex-row items-start justify-between mb-8 border-b pb-4 gap-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Panel Admin</h1>
                                </div>
                                
                                <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                                    <div class="text-right text-sm text-gray-600">
                                        <p class="font-semibold text-gray-800">${formatDate(state.currentTime)}</p>
                                        <p>${formatTime(state.currentTime)} WIB</p>
                                    </div>
                                    <div class="flex flex-wrap gap-2 justify-end">
                                        <button onclick="state.showChangePassword = true; render();"
                                            class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                            </svg>
                                            Ganti Password
                                        </button>
                                        <button onclick="state.showEmployeeForm = true; render();"
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                            Kelola Karyawan
                                        </button>
                                        <button onclick="handleAdminLogout();"
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                            </svg>
                                            Logout
                                        </button>
                                    </div>
                                </div>
                            </div>

                            ${state.showChangePassword ? renderChangePasswordModal() : ''}
                            ${state.showEmployeeForm ? renderEmployeeFormModal() : ''}

                            <!-- Statistics -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-yellow-100 p-4 rounded-xl border border-yellow-200">
                                    <p class="text-sm text-yellow-800">Menunggu Persetujuan</p>
                                    <p class="text-3xl font-bold text-yellow-900">${pendingRequests.length}</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded-xl border border-green-200">
                                    <p class="text-sm text-green-800">Disetujui</p>
                                    <p class="text-3xl font-bold text-green-900">${approvedCount}</p>
                                </div>
                                <div class="bg-red-100 p-4 rounded-xl border border-red-200">
                                    <p class="text-sm text-red-800">Ditolak</p>
                                    <p class="text-3xl font-bold text-red-900">${rejectedCount}</p>
                                </div>
                            </div>

                            <!-- Pending Requests -->
                            <div class="mb-8">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">
                                    Pengajuan Cuti Menunggu Persetujuan (${pendingRequests.length})
                                </h2>
                                ${pendingRequests.length === 0 ? `
                                    <p class="text-gray-500 text-center py-8 bg-gray-50 rounded-xl border border-gray-200">
                                        Tidak ada pengajuan cuti yang menunggu
                                    </p>
                                ` : `
                                    <div class="space-y-4">
                                        ${pendingRequests.map(req => renderPendingRequest(req)).join('')}
                                    </div>
                                `}
                            </div>

                            <!-- History -->
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Riwayat Pengajuan Cuti</h2>
                                
                                <div class="flex items-center gap-3 mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200 flex-wrap">
                                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <label class="text-sm font-medium text-gray-700">Filter Tanggal:</label>
                                    <input type="date" id="adminFilterDate" value="${state.adminFilterDate}"
                                        onchange="state.adminFilterDate = this.value; render();"
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-indigo-500">
                                    <button onclick="state.adminFilterDate = ''; render();"
                                        class="text-sm text-red-600 hover:text-red-800 flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Reset
                                    </button>
                                </div>

                                ${filteredProcessedRequests.length === 0 ? `
                                    <p class="text-gray-500 text-center py-8 bg-gray-50 rounded-xl border border-gray-200">
                                        ${state.adminFilterDate ? `Tidak ada riwayat pengajuan pada tanggal ${state.adminFilterDate}` : 'Belum ada riwayat pengajuan'}
                                    </p>
                                ` : `
                                    <div class="space-y-3">
                                        ${filteredProcessedRequests.map(req => renderProcessedRequest(req)).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPendingRequest(req) {
            return `
                <div class="border-2 border-yellow-300 bg-yellow-50 rounded-xl p-4 md:p-6 shadow-md">
                    <div class="flex flex-col md:flex-row items-start justify-between mb-4 pb-2 border-b border-yellow-200 gap-3">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${req.employeeName}</h3>
                            <p class="text-sm text-gray-600">
                                Diajukan: <span class="font-medium">${new Date(req.submittedAt).toLocaleString('id-ID')}</span>
                            </p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium border ${getStatusColor(req.status)}">
                            ${req.status}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Jabatan</p>
                            <p class="font-semibold text-gray-800">${req.jabatan}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Unit Kerja</p>
                            <p class="font-semibold text-gray-800">${req.unitKerja}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Jenis Cuti</p>
                            <p class="font-semibold text-gray-800">${req.cutiType}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Durasi</p>
                            <p class="font-semibold text-gray-800">${req.days} hari (${req.lamaPengambilan})</p>
                        </div>
                        <div class="sm:col-span-2">
                            <p class="text-sm text-gray-600">Tanggal</p>
                            <p class="font-semibold text-gray-800">${req.startDate} s/d ${req.endDate}</p>
                        </div>
                        <div class="sm:col-span-2 lg:col-span-3">
                            <p class="text-sm text-gray-600">Alasan</p>
                            <p class="font-semibold text-gray-800">${req.alasanCuti}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">No. Telepon</p>
                            <p class="font-semibold text-gray-800">${req.nomorTelepon}</p>
                        </div>
                        <div class="sm:col-span-2">
                            <p class="text-sm text-gray-600">Alamat Selama Cuti</p>
                            <p class="font-semibold text-gray-800">${req.alamatCuti}</p>
                        </div>
                        <div class="sm:col-span-2 lg:col-span-3">
                            <p class="text-sm text-gray-600">Petugas Pengganti</p>
                            <p class="font-semibold text-gray-800">${req.petugasPengganti}</p>
                        </div>
                        ${req.jabatan === 'Anggota' ? `
                        <div>
                            <p class="text-sm text-gray-600">Persetujuan Pengawas</p>
                            <p class="font-semibold text-gray-800">${req.persetujuanPengawas}</p>
                        </div>
                        ` : ''}
                    </div>

                    ${req.photo ? `
                    <div class="mt-4 pt-4 border-t border-yellow-200">
                        <p class="text-sm text-gray-600 mb-2">Foto Lampiran:</p>
                        <img src="${req.photo}" alt="Lampiran Pengajuan Cuti" 
                            class="w-full max-w-md rounded-lg shadow-md cursor-pointer hover:opacity-80 transition-opacity"
                            onclick="window.open('${req.photo}', '_blank')">
                        <p class="text-xs text-gray-500 mt-1">Klik gambar untuk melihat ukuran penuh</p>
                    </div>
                    ` : ''}

                    <div class="flex flex-col md:flex-row gap-3 mt-6">
                        ${req.supervisorPhone ? `
                        <button onclick="handleContactSupervisor(${JSON.stringify(req).replace(/"/g, '&quot;')})"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            Tanya Pengawas via WA
                        </button>
                        ` : ''}
                        <button onclick="handleApproveReject('${req.id}', 'approve')" ${state.loading ? 'disabled' : ''}
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Setujui
                        </button>
                        <button onclick="handleApproveReject('${req.id}', 'reject')" ${state.loading ? 'disabled' : ''}
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Tolak
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProcessedRequest(req) {
            return `
                <div class="rounded-xl p-4 shadow-sm border ${getStatusColor(req.status)}">
                    <div class="flex flex-col md:flex-row items-start justify-between gap-2">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${req.employeeName}</h4>
                            <p class="text-sm text-gray-600">
                                ${req.startDate} s/d ${req.endDate} (${req.days} hari - ${req.cutiType})
                            </p>
                            <p class="text-xs text-gray-500">Diajukan: ${new Date(req.submittedAt).toLocaleString('id-ID')}</p>
                            <p class="text-xs text-gray-500">Jabatan: ${req.jabatan} | Unit: ${req.unitKerja}</p>
                            <p class="text-sm text-gray-700 mt-2">Alasan: ${req.alasanCuti}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(req.status)} whitespace-nowrap">
                            ${req.status}
                        </span>
                    </div>
                </div>
            `;
        }

        function renderChangePasswordModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Ganti Password Admin</h3>
                            <button onclick="state.showChangePassword = false; render();"
                                class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Username</label>
                                <input type="text" value="${state.adminUsername}" disabled
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Password Lama</label>
                                <input type="password" id="oldPassword"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    placeholder="Masukkan password lama">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Password Baru</label>
                                <input type="password" id="newPassword"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    placeholder="Minimal 6 karakter">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Konfirmasi Password Baru</label>
                                <input type="password" id="confirmPassword"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    placeholder="Ulangi password baru">
                            </div>

                            <div class="flex justify-end gap-3 mt-6">
                                <button onclick="state.showChangePassword = false; render();"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                                    Batal
                                </button>
                                <button onclick="handleChangePassword()" ${state.loading ? 'disabled' : ''}
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50">
                                    ${state.loading ? 'Menyimpan...' : 'Simpan Password'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEmployeeFormModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl my-8 max-h-[90vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                            <h3 class="text-2xl font-bold text-gray-800">
                                ${state.editingEmployee ? 'Edit Karyawan' : 'Kelola Karyawan'}
                            </h3>
                            <button onclick="state.showEmployeeForm = false; state.editingEmployee = null; state.employeeFormData = { id: '', name: '', totalLeave: 12, supervisorPhone: '' }; render();"
                                class="text-gray-500 hover:text-gray-700 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Form Tambah/Edit -->
                        <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                            <h4 class="font-semibold mb-3">
                                ${state.editingEmployee ? 'Edit Data Karyawan' : 'Tambah Karyawan Baru'}
                            </h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="${state.editingEmployee ? 'opacity-50' : ''}">
                                    <label class="block text-sm font-medium mb-2">
                                        ID Karyawan (NIP/NIK) ${!state.editingEmployee ? '<span class="text-red-500">*</span>' : ''}
                                    </label>
                                    <input type="text" id="empId" value="${state.employeeFormData.id}"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder="Contoh: EMP001"
                                        ${state.editingEmployee ? 'disabled' : ''}>
                                    ${state.editingEmployee ? '<p class="text-xs text-gray-500 mt-1">ID tidak bisa diubah</p>' : ''}
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">
                                        Nama Karyawan <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="empName" value="${state.employeeFormData.name}"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder="Nama lengkap">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">
                                        Total Cuti Tahunan <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" id="empLeave" value="${state.employeeFormData.totalLeave}"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">
                                        No. WA Pengawas <span class="text-gray-500">(opsional)</span>
                                    </label>
                                    <input type="tel" id="empSupervisor" value="${state.employeeFormData.supervisorPhone}"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder="628123456789">
                                    <p class="text-xs text-gray-500 mt-1">Format: 628xxxxxxxxxx (tanpa +)</p>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 mt-4">
                                <button onclick="state.editingEmployee = null; state.employeeFormData = { id: '', name: '', totalLeave: 12, supervisorPhone: '' }; render();"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                                    Batal
                                </button>
                                <button onclick="handleSaveEmployee()" ${state.loading ? 'disabled' : ''}
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50">
                                    ${state.loading ? 'Menyimpan...' : (state.editingEmployee ? 'Update' : 'Tambah')}
                                </button>
                            </div>
                        </div>

                        <!-- Daftar Karyawan -->
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold">Daftar Karyawan (${state.employees.length})</h4>
                            </div>
                            <!-- Pencarian Karyawan -->
                            <div class="mb-3">
                                <div class="relative">
                                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input type="text" id="employeeSearchInput" placeholder="Cari nama atau ID karyawan..." value="${state.employeeSearchTerm}"
                                        oninput="updateEmployeeSearchTerm(this.value)"
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                                </div>
                            </div>
                            <div id="modalEmployeeListContainer" class="space-y-2 max-h-96 overflow-y-auto">
                                ${state.employees.filter(emp => 
                                    emp.name.toLowerCase().includes(state.employeeSearchTerm.toLowerCase()) ||
                                    emp.id.toLowerCase().includes(state.employeeSearchTerm.toLowerCase())
                                ).map(emp => `
                                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 gap-3">
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800">${emp.name}</p>
                                            <p class="text-xs text-gray-500">ID: ${emp.id}</p>
                                            <p class="text-sm text-gray-600">
                                                Total: ${emp.totalLeave} hari | Terpakai: ${emp.usedLeave} hari | Sisa: ${emp.totalLeave - emp.usedLeave} hari
                                            </p>
                                            ${emp.supervisorPhone ? `<p class="text-xs text-blue-600">ðŸ“± WA Pengawas: ${emp.supervisorPhone}</p>` : ''}
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick='handleEditEmployee(${JSON.stringify(emp)})'
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                                Edit
                                            </button>
                                            <button onclick="handleDeleteEmployee('${emp.id}')"
                                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                                Hapus
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResultPage() {
            const { submittedData } = state;
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8">
                            <div class="text-center mb-8">
                                <div class="inline-block bg-green-100 p-4 rounded-full mb-4">
                                    <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Pengajuan Berhasil!</h2>
                                <p class="text-gray-600">Cuti Anda telah diajukan dan menunggu persetujuan admin</p>
                                <p class="text-sm text-gray-500 mt-2">${formatDate(state.currentTime)} | ${formatTime(state.currentTime)} WIB</p>
                                <p class="text-sm text-blue-600 mt-2 font-medium">ðŸ“§ Notifikasi email telah dikirim ke admin</p>
                            </div>

                            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6 mb-6 border border-indigo-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">${submittedData.employee.name}</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-white p-4 rounded-lg border border-gray-100">
                                        <p class="text-sm text-gray-600 mb-1">Total Cuti</p>
                                        <p class="text-2xl font-bold text-blue-600">${submittedData.employee.totalLeave} hari</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border border-gray-100">
                                        <p class="text-sm text-gray-600 mb-1">Cuti Terpakai</p>
                                        <p class="text-2xl font-bold text-purple-600">${submittedData.employee.totalLeave - submittedData.remainingLeave} hari</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border border-gray-100">
                                        <p class="text-sm text-gray-600 mb-1">Sisa Cuti</p>
                                        <p class="text-2xl font-bold text-green-600">${submittedData.remainingLeave} hari</p>
                                    </div>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl p-4 md:p-6 mb-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Detail Pengajuan</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Jabatan:</span>
                                        <span class="font-semibold">${submittedData.request.jabatan}</span>
                                    </div>
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Unit Kerja:</span>
                                        <span class="font-semibold">${submittedData.request.unitKerja}</span>
                                    </div>
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Jenis Cuti:</span>
                                        <span class="font-semibold">${submittedData.request.cutiType}</span>
                                    </div>
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Tanggal:</span>
                                        <span class="font-semibold">${submittedData.request.startDate} s/d ${submittedData.request.endDate}</span>
                                    </div>
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Durasi:</span>
                                        <span class="font-semibold">${submittedData.request.days} hari (${submittedData.request.lamaPengambilan})</span>
                                    </div>
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Status:</span>
                                        <span class="px-3 py-1 rounded-full text-sm font-medium border ${getStatusColor(submittedData.request.status)}">
                                            ${submittedData.request.status}
                                        </span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 block mb-2">Alasan Cuti:</span>
                                        <p class="bg-gray-50 p-3 rounded-lg border border-gray-200">${submittedData.request.alasanCuti}</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 block mb-2">Alamat Selama Cuti:</span>
                                        <p class="bg-gray-50 p-3 rounded-lg border border-gray-200">${submittedData.request.alamatCuti}</p>
                                    </div>
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Nomor Telepon:</span>
                                        <span class="font-semibold">${submittedData.request.nomorTelepon}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 block mb-2">Petugas Pengganti:</span>
                                        <p class="bg-gray-50 p-3 rounded-lg border border-gray-200">${submittedData.request.petugasPengganti}</p>
                                    </div>
                                    ${submittedData.request.jabatan === 'Anggota' ? `
                                    <div class="flex justify-between flex-wrap gap-2">
                                        <span class="text-gray-600">Persetujuan Pengawas:</span>
                                        <span class="font-semibold">${submittedData.request.persetujuanPengawas}</span>
                                    </div>
                                    ` : ''}
                                    ${submittedData.request.photo ? `
                                    <div>
                                        <span class="text-gray-600 block mb-2">Foto Lampiran:</span>
                                        <img src="${submittedData.request.photo}" alt="Lampiran" 
                                            class="w-full max-w-md rounded-lg shadow-md border border-gray-200">
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <button onclick="handleBackToSelect()"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                Kembali ke Halaman Utama
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFormPage() {
            // Use String() conversion for flexible ID matching
            const employee = state.employees.find(e => String(e.id) === String(state.selectedEmployee));
            
            if (!employee) {
                console.error('Employee not found in renderFormPage! ID:', state.selectedEmployee);
                alert('Terjadi kesalahan: Karyawan tidak ditemukan!');
                handleBackToSelect();
                return '';
            }
            
            const showPersetujuan = state.formData.jabatan === 'Anggota';
            const showPhoto = state.formData.cutiType === 'Cuti Sakit';
            
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8">
                            <div class="flex items-center justify-between mb-6 border-b pb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Pengajuan Cuti</h2>
                                <button onclick="handleBackToSelect()" class="text-gray-600 hover:text-gray-800 text-2xl">âœ•</button>
                            </div>

                            <div class="bg-indigo-50 p-4 rounded-xl mb-6 border border-indigo-200">
                                <p class="font-bold text-indigo-800 mb-1">Karyawan: ${employee.name}</p>
                                <p class="text-sm text-gray-600">
                                    Sisa Cuti Tahunan: <span class="font-semibold text-green-700">${employee.totalLeave - employee.usedLeave} hari</span>
                                </p>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Jabatan -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Jabatan <span class="text-red-500">*</span>
                                    </label>
                                    <select id="jabatan" onchange="state.formData.jabatan = this.value; render();"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">Pilih</option>
                                        <option value="Pengawas" ${state.formData.jabatan === 'Pengawas' ? 'selected' : ''}>Pengawas</option>
                                        <option value="Anggota" ${state.formData.jabatan === 'Anggota' ? 'selected' : ''}>Anggota</option>
                                    </select>
                                </div>

                                <!-- Unit Kerja -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Unit Kerja <span class="text-red-500">*</span>
                                    </label>
                                    <select id="unitKerja" onchange="state.formData.unitKerja = this.value; render();"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">Pilih</option>
                                        <option value="Pramubhakti" ${state.formData.unitKerja === 'Pramubhakti' ? 'selected' : ''}>Pramubhakti</option>
                                        <option value="Pramusaji" ${state.formData.unitKerja === 'Pramusaji' ? 'selected' : ''}>Pramusaji</option>
                                    </select>
                                </div>

                                <!-- Jenis Cuti -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Jenis Cuti <span class="text-red-500">*</span>
                                    </label>
                                    <select id="cutiType" onchange="state.formData.cutiType = this.value; render();"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">Pilih</option>
                                        <option value="Cuti Tahunan" ${state.formData.cutiType === 'Cuti Tahunan' ? 'selected' : ''}>Cuti Tahunan</option>
                                        <option value="Cuti Sakit" ${state.formData.cutiType === 'Cuti Sakit' ? 'selected' : ''}>Cuti Sakit</option>
                                    </select>
                                    ${state.formData.cutiType === 'Cuti Sakit' ? `
                                    <p class="text-sm text-amber-700 mt-2 bg-amber-50 p-2 rounded border border-amber-200">
                                        âš ï¸ <strong>Wajib Melampirkan Surat Dokter ataupun Rawat Inap</strong>
                                    </p>
                                    ` : ''}
                                </div>

                                <!-- Alasan Cuti -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Alasan Cuti <span class="text-red-500">*</span>
                                    </label>
                                    <textarea id="alasanCuti" onchange="state.formData.alasanCuti = this.value"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        rows="3" placeholder="Jawaban Anda">${state.formData.alasanCuti}</textarea>
                                </div>

                                <!-- Lama Pengambilan Cuti -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Lama Pengambilan Cuti <span class="text-red-500">*</span>
                                    </label>
                                    <select id="lamaPengambilan" onchange="state.formData.lamaPengambilan = this.value; render();"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">Pilih</option>
                                        <option value="1 Hari" ${state.formData.lamaPengambilan === '1 Hari' ? 'selected' : ''}>1 Hari</option>
                                        <option value="2 Hari" ${state.formData.lamaPengambilan === '2 Hari' ? 'selected' : ''}>2 Hari</option>
                                    </select>
                                </div>

                                <!-- Tanggal Mulai dan Selesai -->
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Terhitung Mulai Tanggal <span class="text-red-500">*</span>
                                        </label>
                                        <input type="date" id="startDate" value="${state.formData.startDate}"
                                            onchange="state.formData.startDate = this.value; render();"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Sampai Dengan Tanggal <span class="text-red-500">*</span>
                                        </label>
                                        <input type="date" id="endDate" value="${state.formData.endDate}"
                                            onchange="state.formData.endDate = this.value; render();"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    </div>
                                </div>

                                <!-- Alamat Selama Cuti -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Alamat Selama Menjalani Cuti <span class="text-red-500">*</span>
                                    </label>
                                    <textarea id="alamatCuti" onchange="state.formData.alamatCuti = this.value"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        rows="3" placeholder="Jawaban Anda">${state.formData.alamatCuti}</textarea>
                                </div>

                                <!-- Nomor Telepon -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Nomor Telepon <span class="text-red-500">*</span>
                                    </label>
                                    <input type="tel" id="nomorTelepon" value="${state.formData.nomorTelepon}"
                                        onchange="state.formData.nomorTelepon = this.value"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="Jawaban Anda">
                                </div>

                                <!-- Petugas Pengganti -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Siapa Petugas yang menggantikan anda selama anda menjalani cuti? <span class="text-red-500">*</span>
                                    </label>
                                    <textarea id="petugasPengganti" onchange="state.formData.petugasPengganti = this.value"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        rows="2" placeholder="Jawaban Anda">${state.formData.petugasPengganti}</textarea>
                                </div>

                                <!-- Persetujuan Pengawas (hanya untuk Anggota) -->
                                ${showPersetujuan ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Apakah Pengajuan cuti anda mendapat persetujuan dari pengawas <span class="text-red-500">*</span>
                                    </label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                            <input type="radio" name="persetujuan" value="Ya Sudah"
                                                ${state.formData.persetujuanPengawas === 'Ya Sudah' ? 'checked' : ''}
                                                onchange="state.formData.persetujuanPengawas = this.value"
                                                class="w-4 h-4 text-indigo-600">
                                            <span class="text-sm text-gray-700">Ya Sudah</span>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                            <input type="radio" name="persetujuan" value="Belum"
                                                ${state.formData.persetujuanPengawas === 'Belum' ? 'checked' : ''}
                                                onchange="state.formData.persetujuanPengawas = this.value"
                                                class="w-4 h-4 text-indigo-600">
                                            <span class="text-sm text-gray-700">Belum</span>
                                        </label>
                                    </div>
                                </div>
                                ` : ''}

                                <!-- Foto Lampiran (hanya untuk Cuti Sakit) -->
                                ${showPhoto ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">
                                        Lampiran Surat Dokter/Rawat Inap <span class="text-red-500">*</span>
                                    </label>
                                    <p class="text-sm text-gray-600 mb-3">
                                        Wajib melampirkan bukti foto surat dokter atau surat rawat inap
                                    </p>
                                    <div class="flex items-center gap-4">
                                        <label class="flex-1 cursor-pointer">
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition-colors">
                                                <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                </svg>
                                                <p class="text-sm text-indigo-600 font-medium">Tambahkan file</p>
                                            </div>
                                            <input type="file" accept="image/*,.pdf,.doc,.docx" capture="environment"
                                                onchange="handlePhotoCapture(event)" class="hidden">
                                        </label>
                                    </div>
                                    ${state.photoPreview ? `
                                    <div class="mt-4">
                                        <img src="${state.photoPreview}" alt="Preview" class="w-full rounded-lg shadow-md border border-gray-200">
                                        <button onclick="state.photoPreview = null; state.formData.photo = null; render();"
                                            class="mt-2 text-sm text-red-600 hover:text-red-800">
                                            Hapus file
                                        </button>
                                    </div>
                                    ` : ''}
                                    ${!state.formData.photo ? `
                                    <p class="text-sm text-red-500 mt-2">Mohon lampirkan foto/dokumen pendukung untuk Cuti Sakit.</p>
                                    ` : ''}
                                </div>
                                ` : ''}

                                ${state.formData.startDate && state.formData.endDate && calculateDays(state.formData.startDate, state.formData.endDate) > 0 ? `
                                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                    <p class="text-sm text-gray-700 flex justify-between">
                                        <span>Durasi Pengajuan:</span> 
                                        <span class="font-bold text-indigo-800">${calculateDays(state.formData.startDate, state.formData.endDate)} hari</span>
                                    </p>
                                </div>
                                ` : ''}

                                <button onclick="handleSubmitLeave()" ${state.loading ? 'disabled' : ''}
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:opacity-50">
                                    ${state.loading ? 'Mengajukan...' : 'Kirim'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSelectPage() {
            const filteredEmployees = state.employees.filter(emp => 
                emp.name.toLowerCase().includes(state.searchTerm.toLowerCase())
            );

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8">
                            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 border-b pb-4 gap-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Sistem Izin Cuti</h1>
                                </div>
                                <div class="flex flex-col items-end w-full md:w-auto">
                                    <div class="text-right text-sm text-gray-600">
                                        <p class="font-semibold text-gray-800">${formatDate(state.currentTime)}</p>
                                        <p>${formatTime(state.currentTime)} WIB</p>
                                    </div>
                                    <button onclick="state.showAdminLogin = true; render();"
                                        class="mt-2 bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Admin
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <div class="relative">
                                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input type="text" id="searchInput" placeholder="Cari nama karyawan..." value="${state.searchTerm}"
                                        oninput="updateSearchTerm(this.value)"
                                        class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                            </div>

                            <p class="text-gray-600 mb-4 font-medium">Pilih nama karyawan untuk mengajukan cuti:</p>
                            
                            <div id="employeeListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto p-2 border border-gray-200 rounded-xl bg-gray-50">
                                ${filteredEmployees.map(emp => `
                                    <button onclick='handleSelectEmployee("${emp.id}")'
                                        class="bg-white hover:bg-indigo-50 border-2 border-gray-200 hover:border-indigo-400 p-4 rounded-xl transition-all text-left shadow-sm">
                                        <div class="flex items-center gap-3">
                                            <div class="bg-indigo-100 p-3 rounded-full flex-shrink-0">
                                                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <span class="font-semibold text-gray-800 block truncate">${emp.name}</span>
                                                <span class="text-xs text-gray-500">Sisa Cuti: ${emp.totalLeave - emp.usedLeave} hari</span>
                                            </div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>

                            ${filteredEmployees.length === 0 ? `
                                <p class="text-center text-gray-500 py-8">Tidak ada karyawan ditemukan</p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.loading && state.employees.length === 0) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 flex items-center justify-center">
                        <div class="text-center">
                            <svg class="w-12 h-12 text-indigo-600 animate-spin mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <p class="text-gray-600">Memuat data dari Google Sheets...</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.error && state.employees.length === 0) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 flex items-center justify-center p-8">
                        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Kesalahan Koneksi</h2>
                            <p class="text-gray-600 mb-6 text-center">${state.error}</p>
                            <button onclick="loadData()"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Coba Lagi
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.showAdminLogin && !state.isAdminLoggedIn) {
                app.innerHTML = renderAdminLogin();
                return;
            }

            if (state.page === 'admin' && state.isAdminLoggedIn) {
                app.innerHTML = renderAdminPanel();
                return;
            }

            if (state.page === 'result' && state.submittedData) {
                app.innerHTML = renderResultPage();
                return;
            }

            if (state.page === 'form' && state.selectedEmployee) {
                app.innerHTML = renderFormPage();
                return;
            }

            app.innerHTML = renderSelectPage();
        }

        // ====================================================================
        // Initialize App
        // ====================================================================
        loadData();
        setInterval(() => {
            state.currentTime = new Date();
            if (state.page === 'select' || state.page === 'admin') {
                // Hanya update waktu tanpa full re-render
                const timeElements = document.querySelectorAll('[data-time]');
                if (timeElements.length > 0) {
                    render(); // Render only if needed
                }
            }
        }, 1000);
    </script>
</body>
</html>
